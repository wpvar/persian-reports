/**
 * WooCommerce Shamsi (aka Jalali, Iranian, Persian) calendar reports
 * 
 * Release under GPLV3 license
 * @copyright Ali Faraji mail.wpvar@gmail.com
 * @copyright https://wpvar.com
 */
function wooprToDate(date){return void 0===date?new Date(0):wooprIsDate(date)?date:new Date(parseFloat(date.toString()))}function wooprIsDate(date){return date instanceof Date}function wooprFormat(date,format){var d=wooprToDate(date);return format.replace(/Y/gm,d.getFullYear().toString()).replace(/m/gm,("0"+(d.getMonth()+1)).substr(-2)).replace(/d/gm,("0"+(d.getDate()+1)).substr(-2)).replace(/H/gm,("0"+(d.getHours()+0)).substr(-2)).replace(/i/gm,("0"+(d.getMinutes()+0)).substr(-2)).replace(/s/gm,("0"+(d.getSeconds()+0)).substr(-2)).replace(/v/gm,("0000"+d.getMilliseconds()%1e3).substr(-3))}function wooprDrawChart(json){wooprTotals=json[0].totals,wooprGroupBy=json[0].totals_grouped_by,wooprSummary={total_sales:json[0].total_sales,net_sales:json[0].net_sales,average_sales:json[0].average_sales,total_orders:json[0].total_orders,total_items:json[0].total_items,total_tax:json[0].total_tax,total_shipping:json[0].total_shipping,total_refunds:json[0].total_refunds,total_discount:json[0].total_discount},jQuery.each(wooprSummary,(function(index){"total_items"==index||"total_orders"==index||"total_refunds"==index?jQuery("#woopr-"+index+" .woopr-summary_result").text(Math.ceil(wooprSummary[index]).toLocaleString()):jQuery("#woopr-"+index+" .woopr-summary_result").text(Math.ceil(wooprSummary[index]).toLocaleString()+" "+wooprApi.currency)})),data={},customers={},discount={},items={},orders={},sales={},shipping={},tax={},jQuery.each(wooprTotals,(function(index){data[index]=wooprTotals[index],jQuery.each(data[index],(function(){customers[index]=data[index].customers,discount[index]=data[index].discount,items[index]=data[index].items,orders[index]=data[index].orders,sales[index]=data[index].sales,shipping[index]=data[index].shipping,tax[index]=data[index].tax}))}));var optionsGlobal={legend:{display:!1},scales:{y:{beginAtZero:!0,ticks:{callback:function(value){if(value%1==0)return value}}}}};document.querySelector("#wooprChartContainer").innerHTML='<canvas id="wooprChart"></canvas><canvas id="wooprChartSecondary"></canvas>',Chart.defaults.font.family=''+wooprApi.wooprFont+', sans-serif, arial',Chart.defaults.font.size=12;var mainChart=new Chart("wooprChart",{type:"line",data:{labels:wooprLabels(wooprGroupBy),datasets:[{label:"فروش",data:Object.values(sales),borderColor:"#7eb0d5",backgroundColor:"#7eafd515",borderWidth:1,tension:.2,fill:!0},{label:"تخفیف",data:Object.values(discount),borderColor:"#fd7f6f",backgroundColor:"#fd806f18",borderWidth:1,tension:.2,fill:!0},{label:"حمل و نقل",data:Object.values(shipping),borderColor:"#b2e061",backgroundColor:"#b1e0611e",borderWidth:1,tension:.2,fill:!0},{label:"مالیات",data:Object.values(tax),borderColor:"#ffb55a",backgroundColor:"#ffb55a1c",borderWidth:1,tension:.2,fill:!0}]},options:optionsGlobal}),mainChartSecondary=new Chart("wooprChartSecondary",{type:"line",data:{labels:wooprLabels(wooprGroupBy),datasets:[{label:"تعداد مشتری",data:Object.values(customers),borderColor:"#ffee65",backgroundColor:"#ffed651e",borderWidth:1,tension:.2,fill:!0},{label:"تعداد",data:Object.values(items),borderColor:"#8bd3c7",backgroundColor:"#8bd3c723",borderWidth:1,tension:.2,fill:!0},{label:"سفارش",data:Object.values(orders),borderColor:"#beb9db",backgroundColor:"#beb9db17",borderWidth:1,tension:.2,fill:!0}]},options:optionsGlobal})}function wooprTrigger(from,to){jQuery(document).ready((function(){0==from&&(from=jQuery(".wooprFromAlt").val()),0==to&&(to=jQuery(".wooprToAlt").val()),+from==+to&&console.log(1),jQuery.ajax({url:wooprApi.root+"wc/v3/reports/sales",method:"GET",data:{date_min:wooprFormat(+from-864e5,"Y-m-d"),date_max:wooprFormat(+to-864e5,"Y-m-d"),owner:"woopr"},beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",wooprApi.nonce),jQuery("#wooprChartsSection").hide(),jQuery(".woopr-loading").show(),jQuery("#wooprForm input").prop("disabled",!0),jQuery(".woopr-summary_result").css("opacity",.5)},success:function(json){wooprDrawChart(json),jQuery("#wooprChartsSection").show(),jQuery(".woopr-loading").hide(),1==wooprApi.wooprWpsh&&wpsh_num(document.querySelector(".woopr-summary")),jQuery("#wooprForm input").prop("disabled",!1),jQuery(".woopr-summary_result").css("opacity",1)},error:function(e){console.log(e)}})}))}function wooprLabels(type){return shDates={},readableDates={},"day"==type?(jQuery.each(wooprTotals,(function(index){splited=index.split("-"),shamsi=wooprToShamsi(wooprParseInt(splited[0]),wooprParseInt(splited[1]),wooprParseInt(splited[2])),shDates[index]=new persianDate([wooprParseInt(shamsi[0]),wooprParseInt(shamsi[1]),wooprParseInt(shamsi[2])]).toLocale("fa").format("D MMMM YYYY")})),Object.values(shDates)):(jQuery.each(wooprTotals,(function(index){splited=index.split("-"),readableDates[index]=wooprfromNow(splited[0]+"-"+splited[1])})),Object.values(readableDates))}function wooprToShamsi(gy,gm,gd){var g_d_m,jy,jm,jd,gy2,days;if(jy=33*~~((days=355666+365*gy+~~(((gy2=gm>2?gy+1:gy)+3)/4)-~~((gy2+99)/100)+~~((gy2+399)/400)+gd+(g_d_m=[0,31,59,90,120,151,181,212,243,273,304,334])[gm-1])/12053)-1595,jy+=4*~~((days%=12053)/1461),(days%=1461)>365&&(jy+=~~((days-1)/365),days=(days-1)%365),days<186?(jm=1+~~(days/31),jd=1+days%31):(jm=7+~~((days-186)/30),jd=1+(days-186)%30),1==jd.toString().length)var njd="0"+jd;else var njd=jd;if(1==jm.toString().length)var njm="0"+jm;else var njm=jm;return[jy,njm,njd]}function wooprParseInt(string){return parseInt(string)}function wooprfromNow(date){var date=new Date(date).getTime(),seconds=Math.floor((new Date-date)/1e3),interval=seconds/31536e3,monthText=" ",monthsText="ماه قبل",yearsText="سال قبل";return interval>1?Math.floor(interval)+" سال قبل":(interval=seconds/2592001)>1?Math.floor(interval)+" ماه قبل":(interval=seconds/2592e3)>1?" ":(interval=seconds/86400)>1?" ":(interval=seconds/3600)>1?" ":(interval=seconds/60)>1?" ":Math.floor(seconds)+"  "}function wooprFrames(){jQuery(".woopr-frames td").on("click",(function(e){var frame;wooprPicker(1e3*jQuery(this).attr("aria-unix"))}))}function wooprPicker(frame=0){var pdFrom=jQuery(".wooprFrom").persianDatepicker({inline:!1,format:"D MMMM YYYY",altField:".wooprFromAlt",altFormat:"unix",initialValue:!0,initialValueType:"gregorian",autoClose:!0,navigator:{scroll:{enabled:!1}},onSelect:function(unix){if(pdFrom.touched=!0,pdTo&&pdTo.options&&pdTo.options.minDate!=unix){var cachedValue=pdTo.getState().selected.unixDate;pdTo.options={minDate:unix},pdTo.touched&&pdTo.setDate(cachedValue)}},dayPicker:{onSelect:function(unix){wooprTrigger(unix,toDate=0)}}}),pdTo=jQuery(".wooprTo").persianDatepicker({inline:!1,format:"D MMMM YYYY",altField:".wooprToAlt",altFormat:"unix",initialValue:!0,initialValueType:"gregorian",autoClose:!0,navigator:{scroll:{enabled:!1}},onSelect:function(unix){if(pdTo.touched=!0,pdFrom&&pdFrom.options&&pdFrom.options.maxDate!=unix){var cachedValue=pdFrom.getState().selected.unixDate;pdFrom.options={maxDate:unix},pdFrom.touched&&pdFrom.setDate(cachedValue)}},dayPicker:{onSelect:function(unix){wooprTrigger(fromDate=0,unix)}}});if(frame>0){var now=(new Date).getTime();pdFrom.setDate(+now-+frame),pdTo.setDate(+now),wooprTrigger(+now-+frame,now)}}wooprPicker(),wooprFrames(),jQuery(document).ready((function(){var wooprFrom,wooprTo;wooprTrigger(jQuery(".wooprFromAlt").val(),jQuery(".wooprToAlt").val())}));